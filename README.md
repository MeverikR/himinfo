<p>Передать следующие данные из CRM himinfo в ЛК CoMagic отчетная форма Сквозная Аналитика:</p>
<p>
<li>факт создания документа “Заказ”, (тег Продажа проставить)</li>
<li>сумма итоговой сделки по документу “Заказ”, (суммы выручки проставить)</li>
<li>наименование приобретенной услуги в рамках “Заказ” (в комментарий дописать)</li></p>


<p>Структура проекта:</p>
<p>server - серверная часть на python3 aiohttp.<br>
<a href="http://main.py">main.py</a> - основная точка входа (его надо запускать)<br>
config - папка с конфигами для rsyslog, supervisor.d, logrotate</p>

## Реализация


Есть основная точка входа 

При простом GET-запросе на этот URL запускается простановка сделок по БД.
В БД лежат телефоны и суммы, которые дергаются раз в сутки из API клиента.
Если БД пуста - ничего не проставится.
Можно "дернуть" ссылку несколько раз - уже проставленные теги - не будут проставляться заново. 

Чтобы выполнить обновление БД надо добавить в query_string параметр `update_db`
Такой вызов приводит сначала к обновлению БД из API клиента, а потом проставляем теги сделок.
 
При обновлении БД суммы сделок складываются для всех payments.

При обновлении БД суммы сделок складываются, если этот АОН уже есть в БД складываем суммы сделок для него.

Ответ - вложенный JSON-объект.

Может быть ответ с ошибкой

```json
{
  "success": false,
  "message": "ERROR: No result in CoMagic answer"
}
```

В ответе с ошибкой всегда 2 параметра всего: 
- `"success": false` - это значит ошибка.
- `"message": "ERROR: No result in CoMagic answer"` - это текст ошибки 

В успешном ответе все примерно также как и в ответе с ошибкой, но добавлен параметр `journal`.

В нем:
- `phones_analyzed` - сколько АОНов по базке было проверено
- `communications_found` - для скольких АОНов были найдены коммуникации (это ВСЕГО! с дублями)
- `tags_applied` - сколько тегов "сделка" по итогу проставили
- `tags_removed_updated` - сколько сделок обновлено (2 запроса к DataAPI CoMagic: unset, потом set)

- `problem` - пропущено сделок. Это в том случае, когда нашли коммуникацию, но на ней уже стоит тег с точно такой же суммой сделки. Тут не понятно как поступать, но пока это есть в качестве защиты от двойных запросов на простановку тегов.
  
- `log` - это список АОНов по которым выполнен поиск + результат операции для конкретного АОНа. Формат простой `АОН:Коммуникация`

